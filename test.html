<!DOCTYPE html>
<html>
<head>
  <title>Salesforce REST API Bulk Update</title>
  <style>
  .container {
    display: flex;
    align-items: flex-start;
    gap: 20px;
  }

  .form-area {
    flex: 1;
  }

  .output-area {
    flex: 1;
    max-width: 50%;
    overflow: auto;
    background-color: #f0f0f0;
    padding: 10px;
    border: 1px solid #ccc;
    white-space: pre-wrap;
  }
</style>
</head>
<body>
  <h1>Salesforce REST API è¤‡æ•°ãƒ¬ã‚³ãƒ¼ãƒ‰æ›´æ–°</h1>

  <!-- ğŸ”‘ èªè¨¼æƒ…å ± -->
  <label for="clientId">Client ID:</label>
  <input type="text" id="clientId" size="50" placeholder="Client ID ã‚’å…¥åŠ›"><br><br>

  <label for="redirectUri">Redirect URI:</label>
  <input type="text" id="redirectUri" size="50" placeholder="https://localhost/callback.html"><br><br>

  <button onclick="startAuth()">Salesforceã¸ã®èªè¨¼</button>

  <hr>

  <!-- ğŸ“ JSONå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
  <h2>è¤‡æ•°ãƒ¬ã‚³ãƒ¼ãƒ‰æ›´æ–°</h2>
  <p>ä»¥ä¸‹ã®å½¢å¼ã§JSONã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š</p>
  <pre>
[
  {
    "ContractId": "10010000",
    "MailAddress": "test000666@gmail.com",
    "ProductName": "Mobox ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰2å¹´ãƒ—ãƒ©ãƒ³ SEIBERLING SL201 165/55R14 72V  4æœ¬ã€€å¤‰æ›´å¾Œ222222",
    "PlanStartDate": "2021/10/15",
    "Plan": "ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰",
    "ContractYears": "3å¹´",
    "Tire": "ICEPARTNER2",
    "Size": "185/65R15",
    "Season": "å†¬",
    "Status": "å¥‘ç´„ä¸­",
    "LotationRemaining": "5",
    "SafetyInspectRemaining": "99",
    "CenterfitRemaining": "6",
    "NitrogenGasFillingRemaining": "99",
    "PunctureReparationRemaining": "1",
    "CloakRemaining": "0",
    "Option": "ã‚¯ãƒ­ãƒ¼ã‚¯",
    "CancellationReason": "è§£ç´„ç†ç”±123"
  },
  {
    "ContractId": "10010001",
    "MailAddress": "test000666@gmail.com",
    "ProductName": "Mobox ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰2å¹´ãƒ—ãƒ©ãƒ³ SEIBERLING SL201 165/55R14 72V  4æœ¬ã€€å¤‰æ›´å¾Œ222222",
    "PlanStartDate": "2021/10/15",
    "Plan": "ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰",
    "ContractYears": "3å¹´",
    "Tire": "ICEPARTNER2",
    "Size": "185/65R15",
    "Season": "å†¬",
    "Status": "å¥‘ç´„ä¸­",
    "LotationRemaining": "5",
    "SafetyInspectRemaining": "99",
    "CenterfitRemaining": "6",
    "NitrogenGasFillingRemaining": "99",
    "PunctureReparationRemaining": "1",
    "CloakRemaining": "0",
    "Option": "ã‚¯ãƒ­ãƒ¼ã‚¯",
    "CancellationReason": "è§£ç´„ç†ç”±123"
  }
]
  </pre>

  <div class="container">
  <div class="form-area">
      <textarea id="jsonInput" rows="15" cols="80" placeholder="ã“ã“ã«JSONã‚’å…¥åŠ›"></textarea><br><br>
      <button onclick="sendComposite()">ãƒ¬ã‚³ãƒ¼ãƒ‰æ›´æ–°ï¼</button>
  </div>
  <h2>çµæœï¼š</h2>
  <pre id="output" class="output-area"></pre>
</div>

  <script>
    let accessToken = null;
    let instanceUrl = null;

    // ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
    window.onload = function () {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      accessToken = params.get('access_token');
      instanceUrl = params.get('instance_url');
      // ğŸ‘‡ URLã‹ã‚‰ãƒãƒƒã‚·ãƒ¥ã‚’æ¶ˆã™ï¼
      //if (window.history && window.history.replaceState) {
      //  window.history.replaceState(null, null, window.location.pathname);
      //}
    };

    // èªè¨¼å‡¦ç†
    function startAuth() {
      const clientId = document.getElementById('clientId').value.trim();
      const redirectUriRaw = document.getElementById('redirectUri').value.trim();

      if (!clientId || !redirectUriRaw) {
        alert('Client ID ã¨ Redirect URI ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼');
        return;
      }

      const redirectUri = encodeURIComponent(redirectUriRaw);
      const codeVerifier = generateCodeVerifier(); 
      const codeChallenge = generateCodeChallenge(codeVerifier);
      //const authUrl = `https://test.salesforce.com/services/oauth2/authorize?response_type=token&client_id=${clientId}&redirect_uri=${redirectUri}`;
      const authUrl = `https://test.salesforce.com/services/oauth2/authorize?response_type=code&client_id=${clientId}&redirect_uri=${redirectUri}&code_challenge=${codeChallenge}&code_challenge_method=S256`;
      window.location.href = authUrl;
    }

    // ãƒ©ãƒ³ãƒ€ãƒ ãªæ–‡å­—åˆ—ã‚’ç”Ÿæˆ
    function generateCodeVerifier(length = 128) {
      const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
      let result = '';
      const values = new Uint32Array(length);
      window.crypto.getRandomValues(values);
      for (let i = 0; i < length; i++) {
        result += charset[values[i] % charset.length];
      }
      return result;
    }

    // SHA256ã§ãƒãƒƒã‚·ãƒ¥ã—ã¦Base64URLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
    async function generateCodeChallenge(codeVerifier) {
      const encoder = new TextEncoder();
      const data = encoder.encode(codeVerifier);
      const digest = await window.crypto.subtle.digest('SHA-256', data);
      const base64 = btoa(String.fromCharCode(...new Uint8Array(digest)))
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=+$/, '');
      return base64;
    }

    // Composite APIã§ä¸€æ‹¬æ›´æ–°
    async function sendComposite() {
      if (!accessToken || !instanceUrl) {
        alert('èªè¨¼ãŒå¿…è¦ã§ã™ï¼');
        return;
      }

      let records;
      try {
        records = JSON.parse(document.getElementById('jsonInput').value);
      } catch (e) {
        alert('JSONã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ï¼');
        return;
      }

      const url = `${instanceUrl}/services/apexrest/syncHoldingVehicles`;

      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify( records )
        });

        const result = await response.json();
        document.getElementById('output').textContent = JSON.stringify(result, null, 2);
      } catch (err) {
        document.getElementById('output').textContent = 'ğŸ’¥ ã‚¨ãƒ©ãƒ¼: ' + err.message;
      }
    }
  </script>
</body>
</html>
